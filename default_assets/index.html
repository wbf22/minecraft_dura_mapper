<!DOCTYPE html>
<html>

<head>
    <title>Leaflet Multiple Images</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <style>
        body {
            margin: 0;
            background: #111;
        }

        #map_container {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
            background: #111;
            cursor: grab;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
        }


        .map-image {
            display: block;
            user-select: none; /* prevents accidental text selection */
            pointer-events: none; /* mouse events go to container */
            position: absolute;
        }

        #coordinates {
            position: fixed;
            top: 0px;
            left: 0px;
            z-index: 1000;
            background-color: #e4e4e4;
            padding: 0.5rem;
            border-radius: 5px;
            margin: 0.5rem;
        }
    </style>
</head>

<body>
    <div id="map_container">
        <div id="map">
            
        </div>
    </div>

    <div id="coordinates">
        x: 0  y: 0  (pixel not minecraft xz)
    </div>


    <!-- init -->
    <script>

        
    </script>




    <!-- ************ -->
    <!-- IMAGE TILING -->
    <!-- ************ -->


    <!-- general -->
    <script>
        const TARGET_WINDOW_WIDTH_IN_IMAGES = 4;

        const map_container = document.getElementById('map_container');
        const map = document.getElementById('map');
        const coordinates = document.getElementById('coordinates');

    </script>


    <!-- panning -->
    <script>
        
        let isDragging = false;
        let startX, startY;
        let offsetX = window.innerWidth/2, offsetY = window.innerHeight/2;
        let scale = 0.01;
        const MAX_SCALE = 10.1;
        const MIN_SCALE = 0.00001;

        let coor_x = 0;
        let coor_y = 0;
        let center_x = 0;
        let center_y = 0;
        let start_x_in_units = -window.innerWidth/2;
        let start_y_in_units = -window.innerHeight/2;
        let end_x_in_units = window.innerWidth/2;
        let end_y_in_units = window.innerHeight/2;
        let layers = [
            {
                start: [-16, -16],
                end : [15, 15],
                units_per_image : 8192,
                path: "test_images/level_0"
            },
            {
                start: [-4, -4],
                end : [3, 3],
                units_per_image : 8192*4,
                path: "test_images/level_1"
            },
            {
                start: [-1, -1],
                end : [0, 0],
                units_per_image : 8192*16,
                path: "test_images/level_2"
            },
            {
                start: [-1, -1],
                end : [0, 0],
                units_per_image : 8192*256,
                path: "test_images/level_3"
            }
        ];
        let UNITS_PER_CURRENT_IMAGE_SIZE = 8192;


        map.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;

        map_container.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX - offsetX;
            startY = e.clientY - offsetY;
            map_container.style.cursor = 'grabbing';
        });

        map_container.addEventListener('mousemove', (e) => {
            update_coordinates(e);

            if (!isDragging) return;
            offsetX = e.clientX - startX;
            offsetY = e.clientY - startY;
            map.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;

        });

        map_container.addEventListener('mouseup', () => {
            isDragging = false;
            map_container.style.cursor = 'grab';
        });

        map_container.addEventListener('mouseleave', () => {
            isDragging = false;
            map_container.style.cursor = 'grab';
        });

        map_container.addEventListener('wheel', (e) => {
            e.preventDefault();
            let old_scale = scale;

            // determine zoom factor
            let zoomFactor = 0.01 * 20 * scale;
            // console.log("zoomFactor", zoomFactor);
            // console.log("scale", scale);
            

            scale += e.deltaY > 0? zoomFactor : -zoomFactor;

            if (scale < MIN_SCALE) {
                scale = MIN_SCALE;
            }
            if (scale > MAX_SCALE) {
                scale = MAX_SCALE;
            }

            // modify offset on zoom
            let rect = map.getBoundingClientRect();
            let mouse_x_from_map_left = e.clientX - rect.left;
            let mouse_y_from_map_top = e.clientY - rect.top;

            let new_mouse_x_from_map_left = scale * mouse_x_from_map_left / old_scale;
            let new_mouse_y_from_map_top = scale * mouse_y_from_map_top / old_scale;

            offsetX = Math.round(e.clientX - new_mouse_x_from_map_left);
            offsetY = Math.round(e.clientY - new_mouse_y_from_map_top);


            map.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
            // console.log("offsetX", offsetX);
            // console.log("offsetY", offsetY);
            // console.log("scale", scale);

            update_coordinates(e);
        });

        function update_coordinates(e) {

            const units_per_window_pixel = get_units_per_window_pixel();
            // console.log("units_per_window_pixel", units_per_window_pixel);
            // console.log("1/scale", 1/scale);

            coor_x = (e.clientX - offsetX) * units_per_window_pixel;
            coor_y = (e.clientY - offsetY) * units_per_window_pixel;
            coordinates.innerHTML = `x: ${coor_x.toFixed(2)}  y: ${coor_y.toFixed(2)}  (pixel not minecraft xz)`;

        }


        function update_window_units() {

            const units_per_window_pixel = get_units_per_window_pixel();
            center_x = (window.innerWidth/2 - offsetX) * units_per_window_pixel;
            center_y = (window.innerHeight/2 - offsetY) * units_per_window_pixel;

            const window_width_in_units = units_per_window_pixel * window.innerWidth;
            const window_height_in_units = units_per_window_pixel * window.innerHeight;
            start_x_in_units = center_x - window_width_in_units/2;
            start_y_in_units = center_y - window_height_in_units/2;
            end_x_in_units = center_x + window_width_in_units/2;
            end_y_in_units = center_y + window_height_in_units/2;

            // console.log("[", start_x_in_units.toFixed(2), ", ", start_y_in_units.toFixed(2), "] [", end_x_in_units.toFixed(2), ", ", end_y_in_units.toFixed(2), "]");
        }

        function get_units_per_window_pixel() {
            
            // const window_image_size = map.children[0].getBoundingClientRect().width;
            // return UNITS_PER_CURRENT_IMAGE_SIZE / window_image_size;

            return 1 / scale;
        }
        
    </script>

    <!-- add data -->
    <script>
        // let IMG_SIZE = 256;
        // let IMG_SRC = "256x256_test.png";

        // let IMG_SIZE = 1024;
        // let IMG_SRC = "1024x1024_test.png";

        // let IMG_SIZE = 4096;
        // let IMG_SRC = "4096x4096_test.png";

        let LEVEL = 1;


        let IMAGES_IN_MAP = new Map();

        function init(tile_layers) {
            layers = tile_layers;
            UNITS_PER_CURRENT_IMAGE_SIZE = layers[LEVEL].units_per_image;
            update_window_units();
        }

        function set_images() {

            // DETERMINE level to stay under max_images_in_view
            
            // get units in window
            const window_width_pixels = window.innerWidth;
            const units_per_window_pixel = get_units_per_window_pixel();
            const units_in_window = window_width_pixels * units_per_window_pixel;

            const images_per_window = units_in_window / UNITS_PER_CURRENT_IMAGE_SIZE;


            let lower_level_images_per_window = 0;
            if (LEVEL != 0) {
                lower_level_images_per_window = units_in_window / layers[LEVEL-1].units_per_image;
            }
            let upper_level_images_per_window = 0;
            if (LEVEL+1 < layers.length) {
                upper_level_images_per_window = units_in_window / layers[LEVEL+1].units_per_image;
            }

            // DECREASE level if there are less images in view than the min
            if (images_per_window < TARGET_WINDOW_WIDTH_IN_IMAGES) {
                if (LEVEL != 0) {
                    LEVEL--;
                    IMAGES_IN_MAP.clear();
                    map.replaceChildren();
                    UNITS_PER_CURRENT_IMAGE_SIZE = layers[LEVEL].units_per_image;
                    console.log("LEVEL ", LEVEL);
                }
            }
            // INCREASE level if there are more images 
            else {
                // if next level would be closer to MIN_WINDOW_WIDTH_IN_IMAGES increase
                if (LEVEL+1 < layers.length && images_per_window > TARGET_WINDOW_WIDTH_IN_IMAGES * 2) {
                    LEVEL++;
                    IMAGES_IN_MAP.clear();
                    map.replaceChildren();
                    UNITS_PER_CURRENT_IMAGE_SIZE = layers[LEVEL].units_per_image;
                    console.log("LEVEL ", LEVEL);
                }
            }

            console.log("units_per_window_pixel", units_per_window_pixel);
            console.log("window_width_pixels", window_width_pixels);
            console.log("UNITS_PER_CURRENT_IMAGE_SIZE", UNITS_PER_CURRENT_IMAGE_SIZE);
            console.log("units per window", units_in_window);
            console.log("images per window", units_in_window / UNITS_PER_CURRENT_IMAGE_SIZE);

            // DETERMINE any missing images and load them
            for (let x = start_x_in_units; x < end_x_in_units + UNITS_PER_CURRENT_IMAGE_SIZE; x += UNITS_PER_CURRENT_IMAGE_SIZE) {
                for (let y = start_y_in_units; y < end_y_in_units + UNITS_PER_CURRENT_IMAGE_SIZE; y += UNITS_PER_CURRENT_IMAGE_SIZE) {
                    let image_x = round_to_multiple(x, UNITS_PER_CURRENT_IMAGE_SIZE);
                    let image_y = round_to_multiple(y, UNITS_PER_CURRENT_IMAGE_SIZE);

                    let file_name = `${image_x}_${image_y}.png`
                    if (!IMAGES_IN_MAP.has(file_name)) {

                        let img_offset_pixels_x = (image_x - center_x);
                        let img_offset_pixels_y = (image_y - center_y);

                        const path = layers[LEVEL].path + "/" + file_name;

                        const img = document.createElement("img");
                        img.src = path;
                        img.className = "map-image"
                        img.style.top = `${img_offset_pixels_y}px`;
                        img.style.left = `${img_offset_pixels_x}px`;
                        img.style.width = `${UNITS_PER_CURRENT_IMAGE_SIZE}px`;
                        img.style.height = `${UNITS_PER_CURRENT_IMAGE_SIZE}px`;
                        img.loading = 'lazy';
                        map.appendChild(img);

                        // IMAGES_IN_MAP.set(file_name, img);

                        console.log(path, "img_offset_pixels_x", img_offset_pixels_x, "img_offset_pixels_y", img_offset_pixels_y);
                        // console.log("img.offsetWidth", img.offsetWidth);
                    }
                }    
            }
            
            
        }

        function round_to_multiple(value, multiple) {
            let div = Math.floor(value / multiple);
            return div * multiple;
        }

        init(layers);
        set_images();



        // let IMG_SIZE = 8192;
        // let IMG_SRC = "pig_8192.png";

        // const REGION_SIZE_PIXELS = 32*16*16;

        // let IMAGES = 4 * REGION_SIZE_PIXELS / IMG_SIZE;
        // // let IMAGES = 524288 / IMG_SIZE;

        // for (let x = 0; x < IMAGES; x++) {
        //     for (let z = 0; z < IMAGES; z++) {
        //         const img = document.createElement("img");
        //         img.src = IMG_SRC
        //         img.className = "map-image"
        //         img.style.top = `${z*IMG_SIZE}px`;
        //         img.style.left = `${x*IMG_SIZE}px`;
        //         img.loading = 'lazy';
        //         map.appendChild(img);

        //     }
        // }

    </script>


</body>

</html>